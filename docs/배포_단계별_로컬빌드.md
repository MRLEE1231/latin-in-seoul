# 배포 단계별 가이드 (로컬 빌드)

로컬에서 빌드한 뒤 서버에 반영하는 순서입니다.

---

## 한 번에 보기 (복사용)

**로컬 (PowerShell, 프로젝트 폴더에서)**

```powershell
cd c:\testWorkspace\latin_in_seoul
git add .
git status
git commit -m "배포 반영"
git push origin main

$env:DATABASE_URL = "postgresql://postgres:서버DB비밀번호@latin-postgres:5432/latin_in_seoul"
docker build --build-arg DATABASE_URL=$env:DATABASE_URL -t latin-in-seoul .
docker save latin-in-seoul -o latin-in-seoul.tar

scp -i "C:\Users\User\Downloads\ssh-key-2026-02-13.key" latin-in-seoul.tar ubuntu@134.185.116.81:~/
```

**서버 (SSH 접속 후)**

```bash
cd ~
docker load -i latin-in-seoul.tar
cd ~/latin-in-seoul
docker stop latin-app 2>/dev/null; docker rm latin-app 2>/dev/null
docker run -d --name latin-app --network latin-net -p 3000:3000 \
  -v $(pwd)/data/uploads:/app/public/uploads \
  -v $(pwd)/public/ads:/app/public/ads \
  --env-file .env --restart unless-stopped \
  --log-driver json-file --log-opt max-size=10m --log-opt max-file=3 \
  latin-in-seoul
docker exec -it latin-app npx prisma migrate deploy
```

---

## 1단계: Git — 변경사항 확인 및 커밋

로컬 프로젝트 폴더에서 진행합니다.

### 1-1. 상태 확인

```powershell
cd c:\testWorkspace\latin_in_seoul
git status
```

- 변경·추가된 파일 목록을 확인합니다.

### 1-2. 빌드 산출물이 Git에 들어가지 않도록 확인

- `latin-in-seoul.tar`(Docker 이미지 저장 파일)는 **절대 커밋하지 않습니다** (용량 큼).
- `.gitignore`에 아래가 있는지 확인하고, 없으면 추가하세요.
  - `latin-in-seoul.tar`
  - `*.tar`

### 1-3. 스테이징 및 커밋

```powershell
git add .
# tar 파일이 실수로 들어가지 않았는지 다시 확인
git status

git commit -m "광고 관리(수업/기타, 이미지 업로드/압축), 메인 레이아웃 변경 등 반영"
```

- 커밋 메시지는 원하는 대로 바꿔도 됩니다.

### 1-4. 원격 저장소로 푸시

```powershell
git push origin main
```

- 브랜치 이름이 `main`이 아니면 해당 브랜치로 `push`하세요 (예: `master`).

---

## 2단계: 로컬에서 Docker 이미지 빌드

같은 로컬 PC, 같은 프로젝트 폴더에서 진행합니다.

### 2-1. DATABASE_URL 설정 (PowerShell)

서버에서 쓰는 PostgreSQL 주소와 **동일한 값**을 씁니다. (빌드 시 실제 DB 접속은 하지 않습니다.)

```powershell
cd c:\testWorkspace\latin_in_seoul

$env:DATABASE_URL = "postgresql://postgres:서버DB비밀번호@latin-postgres:5432/latin_in_seoul"
```

- `서버DB비밀번호`를 실제 Postgres 비밀번호로 바꾸세요.
- 서버 `.env`에 있는 `DATABASE_URL`을 그대로 복사해 써도 됩니다.

### 2-2. Docker 이미지 빌드

```powershell
docker build --build-arg DATABASE_URL=$env:DATABASE_URL -t latin-in-seoul .
```

- 끝날 때까지 기다립니다 (몇 분~십 수 분 소요될 수 있음).
- 에러가 나면 터미널 메시지를 확인한 뒤, `DATABASE_URL`·Docker 설치·네트워크 등을 점검하세요.

### 2-3. 이미지를 파일로 저장

```powershell
docker save latin-in-seoul -o latin-in-seoul.tar
```

- 프로젝트 폴더에 `latin-in-seoul.tar`가 생깁니다 (수백 MB 정도).
- 이 파일은 **Git에 올리지 말고**, 다음 단계에서 서버로만 복사합니다.

---

## 3단계: 서버로 파일 복사 (scp)

로컬에 만든 `latin-in-seoul.tar`를 서버 홈(`~/`)으로 옮깁니다. **프로젝트 폴더에서** 실행하세요.

```powershell
scp -i "C:\Users\User\Downloads\ssh-key-2026-02-13.key" latin-in-seoul.tar ubuntu@134.185.116.81:~/
```

- 키 경로나 서버 IP가 바뀌면 해당 부분만 수정해서 사용하면 됩니다.
- WinSCP 등 GUI로 `latin-in-seoul.tar`를 서버 `~/`에 업로드해도 됩니다.

---

## 4단계: 서버에서 이미지 적용 및 앱 재실행

서버에 SSH로 접속한 뒤 진행합니다.

### 4-1. 이미지 불러오기

```bash
cd ~
docker load -i latin-in-seoul.tar
```

### 4-2. 앱 디렉터리로 이동

```bash
cd ~/latin-in-seoul
```

- 실제 경로가 `~/latin_in_seoul`이면 그쪽으로 이동하세요.

### 4-3. .env 위치 확인

- 반드시 **앱이 있는 디렉터리**(`~/latin-in-seoul` 또는 `~/latin_in_seoul`)에 `.env`가 있어야 합니다.
- 없으면 이 디렉터리에 `.env`를 만들고 `DATABASE_URL`, `AUTH_SECRET` 등을 서버용으로 설정하세요.

### 4-4. 기존 앱 컨테이너 중지·삭제 후 새로 실행

```bash
docker stop latin-app 2>/dev/null; docker rm latin-app 2>/dev/null

docker run -d --name latin-app --network latin-net -p 3000:3000 \
  -v $(pwd)/data/uploads:/app/public/uploads \
  -v $(pwd)/public/ads:/app/public/ads \
  --env-file .env --restart unless-stopped \
  --log-driver json-file --log-opt max-size=10m --log-opt max-file=3 \
  latin-in-seoul
```

- **주의:** 위 명령은 **앱이 있는 디렉터리**(`~/latin-in-seoul` 등)에서 실행해야 합니다. 그래야 `--env-file .env`와 `$(pwd)/data/uploads` 등이 올바르게 잡힙니다.
- 광고 이미지용으로 `public/ads`를 볼륨으로 붙였습니다. 서버에 `public/ads`가 없다면 `mkdir -p public/ads` 후 실행하거나, 해당 `-v` 줄을 제거해도 됩니다.

### 4-5. DB 마이그레이션 실행

```bash
docker exec -it latin-app npx prisma migrate deploy
```

- 새로 추가한 테이블/컬럼(예: `home_ads`의 `kind`, `postId` 등)이 이때 적용됩니다.

### 4-6. (선택) tar 파일 삭제

디스크 여유를 위해 서버에서 이미지 로드 후 tar는 지워도 됩니다.

```bash
rm ~/latin-in-seoul.tar
```

---

## 요약 체크리스트

| 순서 | 위치   | 할 일 |
|------|--------|--------|
| 1    | 로컬   | `git add` → `commit` → `push` |
| 2    | 로컬   | `$env:DATABASE_URL = "..."` → `docker build` → `docker save -o latin-in-seoul.tar` |
| 3    | 로컬   | `latin-in-seoul.tar`를 서버 `~/`로 복사 (scp / WinSCP) |
| 4    | 서버   | `docker load` → `cd ~/latin-in-seoul` → 기존 앱 중지·삭제 → `docker run` → `prisma migrate deploy` |

이후 배포할 때마다: 로컬에서 코드 수정 → 1~3 반복 → 서버에서 4만 다시 실행하면 됩니다.
